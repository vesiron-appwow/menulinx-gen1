<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#28A745" />
  <meta name="description" content="MenuLinx ‚Äî commission-free ordering for independents" />
  <title>MenuLinx ‚Äî Order</title>

  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='120' fill='%2328A745'/><text x='256' y='350' font-size='260' text-anchor='middle' fill='white'>üçΩÔ∏è</text></svg>">
  <style>
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#F2F2F2;color:#0A0A0A;padding-bottom:92px}
    :root{--p:#28A745;--pd:#1e7e34;--g:#4A4A4A;--lg:#F2F2F2;--w:#fff;--d:#0A0A0A}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(135deg,var(--p),var(--pd));color:#fff;padding:14px 16px;box-shadow:0 2px 10px rgba(0,0,0,.12)}
    .top{display:flex;gap:12px;align-items:center}
    .logo{width:52px;height:52px;border-radius:14px;background:#fff;display:flex;align-items:center;justify-content:center;font-size:26px}
    .name h1{margin:0;font-size:18px;line-height:1.1}
    .name p{margin:3px 0 0;font-size:13px;opacity:.92}
    .status{display:flex;gap:14px;margin-top:10px;font-size:12.5px;opacity:.95}
    .status span{display:flex;gap:6px;align-items:center}

    /* Venue OPEN/CLOSED banner (Gen-1) */
    .venueBanner{padding:10px 12px;margin-top:12px;border-radius:10px;font-weight:900;text-align:center}
    .venueOpen{background:#E1F7F4;color:#002B36}
    .venueClosed{background:#FF6F3C;color:#000}

    .toggle{display:flex;gap:8px;margin-top:12px;background:rgba(255,255,255,.2);backdrop-filter:blur(10px);padding:10px;border-radius:10px}
    .toggle button{flex:1;padding:10px;border-radius:8px;border:2px solid rgba(255,255,255,.28);background:transparent;color:#fff;font-weight:700;cursor:pointer}
    .toggle button.active{background:#fff;color:var(--p);border-color:#fff}
    .bar{padding:14px 16px;background:#fff;border-bottom:1px solid #e6e6e6}
    .search{width:100%;padding:13px;border:2px solid #e6e6e6;border-radius:10px;font-size:16px}
    .chips{display:flex;gap:8px;padding:12px 16px;overflow:auto;background:#fff;border-bottom:1px solid #ededed}
    .chip{padding:10px 14px;border-radius:999px;background:var(--lg);font-weight:700;white-space:nowrap;cursor:pointer;border:2px solid transparent}
    .chip.active{background:var(--p);color:#fff}
    .section{padding:14px 16px}
    .section h2{margin:0 0 10px;font-size:18px}
    .item{display:flex;gap:12px;background:#fff;border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.07)}
    .emoji{width:76px;height:76px;border-radius:12px;background:linear-gradient(135deg,#f1f1f1,#e0e0e0);display:flex;align-items:center;justify-content:center;font-size:34px;flex:0 0 auto}
    .content{flex:1}
    .title{font-weight:900;margin:0 0 2px}
    .desc{margin:0 0 10px;color:var(--g);font-size:13.5px;line-height:1.35}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .price{font-weight:900;font-size:18px;color:var(--p)}
    .btn{border:none;border-radius:999px;padding:9px 16px;font-weight:900;cursor:pointer}
    .btnAdd{background:var(--p);color:#fff}
    .btnAdd:disabled{opacity:.45;cursor:not-allowed}
    .badgeOff{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:800;color:#B00020;background:#FFE7EA;padding:6px 10px;border-radius:999px}
    .cart{position:fixed;left:14px;right:14px;bottom:14px;background:#0A0A0A;color:#fff;border-radius:14px;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 10px 22px rgba(0,0,0,.28);cursor:pointer}
    .cart.hidden{display:none}
    .count{width:34px;height:34px;border-radius:999px;background:var(--p);display:flex;align-items:center;justify-content:center;font-weight:900}
    .cartLeft{display:flex;align-items:center;gap:12px}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.show{display:flex}
    .panel{width:100%;max-width:560px;background:#fff;border-radius:18px;overflow:hidden}
    .panelHead{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #eee}
    .panelHead h3{margin:0;font-size:18px}
    .close{border:none;background:transparent;font-size:26px;cursor:pointer;color:#666}
    .panelBody{padding:16px;max-height:70vh;overflow:auto}
    .cartItem{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f0f0f0;gap:12px}
    .qty{display:flex;align-items:center;gap:10px}
    .qty button{width:34px;height:34px;border-radius:999px;border:2px solid var(--p);background:#fff;color:var(--p);font-weight:900;cursor:pointer}
    .summary{border-top:2px solid #eee;padding:16px}
    .sumRow{display:flex;justify-content:space-between;margin-bottom:10px}
    .sumRow.total{font-size:18px;font-weight:900}
    .cta{width:100%;padding:14px;border:none;border-radius:12px;background:var(--p);color:#fff;font-weight:900;font-size:16px;cursor:pointer}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    .field input,.field textarea{padding:12px;border:2px solid #e6e6e6;border-radius:10px;font-size:15px}
    .hint{font-size:12.5px;color:#666}
    .toast{position:fixed;left:12px;right:12px;top:12px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;display:none;z-index:60}
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>

  <header>
    <div class="top">
      <div class="logo" id="logo">üçΩÔ∏è</div>
      <div class="name">
        <h1 id="restName">Loading‚Ä¶</h1>
        <p id="restTag">Commission-free ordering</p>
      </div>
    </div>
    <div class="status">
      <span>‚è∞ <span id="hours">Open today</span></span>
      <span>üìç <span id="area">Local delivery</span></span>
    </div>

    <!-- Venue OPEN/CLOSED banner (Gen-1) -->
    <div id="venueBanner" class="venueBanner">Checking availability‚Ä¶</div>

    <div class="toggle">
      <button id="btnDelivery" class="active" type="button">üö¥ Delivery</button>
      <button id="btnCollection" type="button">üèÉ Collection</button>
    </div>
  </header>

  <div class="bar">
    <input class="search" id="search" type="text" placeholder="Search menu‚Ä¶" autocomplete="off" />
  </div>

  <div class="chips" id="chips"></div>
  <div id="menu"></div>

  <div class="cart hidden" id="cartBar">
    <div class="cartLeft">
      <div class="count" id="cartCount">0</div>
      <div>
        <div style="font-weight:900">View Cart</div>
        <div style="opacity:.85;font-size:12.5px" id="cartItemsLine">0 items</div>
      </div>
    </div>
    <div style="font-weight:900;font-size:18px" id="cartTotal">¬£0.00</div>
  </div>

  <!-- Cart Modal -->
  <div class="modal" id="cartModal">
    <div class="panel">
      <div class="panelHead">
        <h3>Your Order</h3>
        <button class="close" type="button" onclick="ui.closeCart()">√ó</button>
      </div>
      <div class="panelBody" id="cartBody"></div>
      <div class="summary">
        <div class="sumRow"><span>Subtotal</span><span id="sumSubtotal">¬£0.00</span></div>
        <div class="sumRow"><span id="sumDeliveryLabel">Delivery</span><span id="sumDeliveryFee">¬£0.00</span></div>
        <div class="sumRow total"><span>Total</span><span id="sumTotal">¬£0.00</span></div>
        <button class="cta" type="button" onclick="ui.openCheckout()">Proceed to Checkout</button>
        <div class="hint" style="margin-top:10px">
          No card payments in Gen-1 (matches many independents). Pay on collection/delivery if required.
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal" id="checkoutModal">
    <div class="panel">
      <div class="panelHead">
        <h3>Checkout</h3>
        <button class="close" type="button" onclick="ui.closeCheckout()">√ó</button>
      </div>
      <div class="panelBody">
        <div class="field">
          <label>Your Name *</label>
          <input id="cName" type="text" placeholder="Name" />
        </div>
        <div class="field">
          <label>Phone Number *</label>
          <input id="cPhone" type="tel" placeholder="07xxx xxxxxx" />
          <div class="hint">Used for order updates (SMS integration later). Gen-1 shows updates on screen.</div>
        </div>
        <div class="field" id="addrWrap">
          <label>Delivery Address *</label>
          <input id="cAddr" type="text" placeholder="House number + street + postcode" />
        </div>
        <div class="field">
          <label>Special Instructions</label>
          <textarea id="cNotes" rows="3" placeholder="Allergies, notes, delivery instructions‚Ä¶"></textarea>
        </div>
        <button class="cta" type="button" onclick="order.place()">Place Order</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal" id="confirmModal">
    <div class="panel">
      <div class="panelHead">
        <h3>Order Confirmed ‚úÖ</h3>
      </div>
      <div class="panelBody">
        <div style="text-align:center;font-size:52px;margin:8px 0 14px">‚úÖ</div>
        <div style="text-align:center;font-weight:900;font-size:22px" id="confirmId">#‚Äî</div>
        <p style="text-align:center;color:#444;margin:10px 0 18px" id="confirmText">
          Your order has been sent to the kitchen.
        </p>
        <div style="background:#F2F2F2;border-radius:12px;padding:12px 14px">
          <div style="font-weight:900;margin-bottom:8px">Live updates</div>
          <div class="hint">
            In Gen-1 we show updates here (accepted / ready / despatched). SMS is added later.
          </div>
          <div style="margin-top:10px;font-weight:800" id="statusLine">Status: NEW</div>
          <div style="margin-top:6px" class="hint" id="etaLine"></div>
        </div>
        <button class="cta" type="button" style="margin-top:14px" onclick="ui.closeConfirm()">Done</button>
      </div>
    </div>
  </div>

  <script>
    // --- PWA registration ---
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => navigator.serviceWorker.register("/sw.js").catch(()=>{}));
    }

    const state = {
      menu: null,
      category: "all",
      q: "",
      deliveryType: "delivery",
      cart: [],
      orderId: null,
      orderPoll: null
    };

    const el = (id) => document.getElementById(id);
    const money = (n) => "¬£" + Number(n).toFixed(2);

    function toast(msg) {
      const t = el("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 2600);
    }

    // Venue OPEN/CLOSED state (Gen-1)
    const VENUE_ID = "default";
    let venueOpen = true;

    async function loadVenueStatus() {
      const b = el("venueBanner");
      try {
        const r = await fetch(`/api/admin/venue-status?venueId=${encodeURIComponent(VENUE_ID)}`);
        const j = await r.json();
        if (!j.ok) throw new Error("venue-status");

        venueOpen = !!j.venue.isOpen;

        if (venueOpen) {
          b.textContent = `OPEN ¬∑ Estimated ready time ~${Number(j.venue.prepMinutes || 0)} mins`;
          b.className = "venueBanner venueOpen";
        } else {
          b.textContent = "CLOSED ¬∑ Orders are not being accepted";
          b.className = "venueBanner venueClosed";
          el("cartBar").classList.add("hidden");
        }
      } catch {
        venueOpen = false;
        b.textContent = "Ordering unavailable";
        b.className = "venueBanner venueClosed";
        el("cartBar").classList.add("hidden");
      }
    }

    // --- Load menu from KV ---
    async function loadMenu() {
      const r = await fetch("/api/menu-get");
      const j = await r.json();
      if (!j.ok) throw new Error("menu");
      state.menu = j.menu;

      el("restName").textContent = state.menu.restaurantName || "MenuLinx";
      el("hours").textContent = state.menu.openingHours || "Open today";
      el("area").textContent = state.menu.serviceArea || "Local delivery";
      if (state.menu.logoEmoji) el("logo").textContent = state.menu.logoEmoji;

      renderChips();
      renderMenu();
      updateCartBar();
    }

    function categories() {
      const items = (state.menu?.items || []).filter(i => i && i.name);
      const cats = [...new Set(items.map(i => i.category || "menu"))];
      return ["all", ...cats];
    }

    function renderChips() {
      const c = el("chips");
      c.innerHTML = "";
      categories().forEach(cat => {
        const d = document.createElement("div");
        d.className = "chip" + (state.category === cat ? " active" : "");
        d.textContent = cat === "all" ? "All" : (cat[0].toUpperCase() + cat.slice(1));
        d.onclick = () => { state.category = cat; renderChips(); renderMenu(); };
        c.appendChild(d);
      });
    }

    function filteredItems() {
      let items = state.menu?.items || [];
      if (state.category !== "all") items = items.filter(i => (i.category || "menu") === state.category);
      if (state.q) {
        const q = state.q.toLowerCase();
        items = items.filter(i => (i.name||"").toLowerCase().includes(q) || (i.description||"").toLowerCase().includes(q));
      }
      return items;
    }

    function renderMenu() {
      const root = el("menu");
      const grouped = {};
      filteredItems().forEach(i => {
        const cat = i.category || "menu";
        grouped[cat] = grouped[cat] || [];
        grouped[cat].push(i);
      });

      const cats = Object.keys(grouped);
      root.innerHTML = cats.map(cat => {
        const items = grouped[cat];
        return `
          <div class="section">
            <h2>${cat === "menu" ? "Menu" : (cat[0].toUpperCase()+cat.slice(1))}</h2>
            ${items.map(i => {
              const off = i.available === false;
              return `
                <div class="item">
                  <div class="emoji">${i.emoji || "üçΩÔ∏è"}</div>
                  <div class="content">
                    <div class="title">${escapeHtml(i.name)}</div>
                    <div class="desc">${escapeHtml(i.description || "")}</div>
                    <div class="row">
                      <div>
                        <div class="price">${money(i.price)}</div>
                        ${off ? `<div style="margin-top:8px"><span class="badgeOff">‚õî Unavailable</span></div>` : ``}
                      </div>
                      <button class="btn btnAdd" ${off ? "disabled" : ""} onclick="cart.add('${String(i.id)}')">Add +</button>
                    </div>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `;
      }).join("");
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    const cart = {
      add(id) {
        if (!venueOpen) return toast("We‚Äôre currently closed");
        const item = (state.menu.items || []).find(x => String(x.id) === String(id));
        if (!item || item.available === false) return;
        const ex = state.cart.find(x => x.id === String(id));
        if (ex) ex.quantity += 1;
        else state.cart.push({ id: String(item.id), name: item.name, price: Number(item.price), quantity: 1 });
        updateCartBar();
        toast("Added to cart");
      },
      change(id, delta) {
        const it = state.cart.find(x => x.id === String(id));
        if (!it) return;
        it.quantity += delta;
        if (it.quantity <= 0) state.cart = state.cart.filter(x => x.id !== String(id));
        ui.renderCart();
        updateCartBar();
      },
      subtotal() {
        return state.cart.reduce((s,i)=>s+(i.price*i.quantity),0);
      }
    };

    function deliveryFee() {
      if (state.deliveryType === "collection") return 0;
      return Number(state.menu?.deliveryFee ?? 2.5);
    }

    function updateCartBar() {
      const count = state.cart.reduce((s,i)=>s+i.quantity,0);
      const total = cart.subtotal() + deliveryFee();
      el("cartCount").textContent = count;
      el("cartItemsLine").textContent = count === 1 ? "1 item" : `${count} items`;
      el("cartTotal").textContent = money(total);
      el("cartBar").classList.toggle("hidden", count === 0);
    }

    const ui = {
      openCart() {
        if (!venueOpen) return toast("We‚Äôre currently closed");
        this.renderCart();
        el("cartModal").classList.add("show");
      },
      closeCart() { el("cartModal").classList.remove("show"); },
      renderCart() {
        const body = el("cartBody");
        body.innerHTML = state.cart.map(i => `
          <div class="cartItem">
            <div>
              <div style="font-weight:900">${escapeHtml(i.name)}</div>
              <div class="hint">${money(i.price)}</div>
            </div>
            <div class="qty">
              <button type="button" onclick="cart.change('${i.id}',-1)">‚àí</button>
              <div style="min-width:18px;text-align:center;font-weight:900">${i.quantity}</div>
              <button type="button" onclick="cart.change('${i.id}',1)">+</button>
            </div>
          </div>
        `).join("");

        const sub = cart.subtotal();
        const fee = deliveryFee();
        el("sumSubtotal").textContent = money(sub);
        el("sumDeliveryFee").textContent = fee === 0 ? "Free" : money(fee);
        el("sumDeliveryLabel").textContent = state.deliveryType === "collection" ? "Collection" : "Delivery";
        el("sumTotal").textContent = money(sub + fee);
      },
      openCheckout() {
        if (!venueOpen) return toast("We‚Äôre currently closed");
        if (!state.cart.length) return;
        this.closeCart();
        el("addrWrap").style.display = state.deliveryType === "delivery" ? "block" : "none";
        el("checkoutModal").classList.add("show");
      },
      closeCheckout() { el("checkoutModal").classList.remove("show"); },
      openConfirm(id) {
        state.orderId = id;
        el("confirmId").textContent = "#" + id.slice(0, 8).toUpperCase();
        el("statusLine").textContent = "Status: NEW";
        el("etaLine").textContent = "";
        el("confirmModal").classList.add("show");
        order.startPoll();
      },
      closeConfirm() {
        el("confirmModal").classList.remove("show");
        order.stopPoll();
      }
    };

    // --- Place order to KV ---
    const order = {
      async place() {
        if (!venueOpen) return toast("We‚Äôre currently closed");

        const name = el("cName").value.trim();
        const phone = el("cPhone").value.trim();
        const addr = el("cAddr").value.trim();
        const notes = el("cNotes").value.trim();

        if (!name) return toast("Enter your name");
        if (!phone) return toast("Enter your phone number");
        if (state.deliveryType === "delivery" && !addr) return toast("Enter delivery address");

        const payload = {
          deliveryType: state.deliveryType,
          customerName: name,
          customerPhone: phone,
          address: state.deliveryType === "delivery" ? addr : "",
          notes,
          items: state.cart.map(i => ({ id: i.id, quantity: i.quantity }))
        };

        const r = await fetch("/api/order-create", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload)
        });

        const j = await r.json().catch(()=>({ok:false,error:"Order failed"}));
        if (!r.ok || !j.ok) {
          toast(j.error || "Order failed");
          return;
        }

        // clear cart
        state.cart = [];
        updateCartBar();
        ui.closeCheckout();
        ui.openConfirm(j.id);
      },

      async pollOnce() {
        if (!state.orderId) return;
        // lightweight: ask admin list endpoint & filter (Gen-1 simple)
        const r = await fetch("/api/order-list?since=0");
        const j = await r.json();
        if (!j.ok) return;
        const o = (j.orders || []).find(x => x.id === state.orderId);
        if (!o) return;

        const st = String(o.status || "new").toUpperCase();
        el("statusLine").textContent = "Status: " + st;

        if (o.status === "accepted" && o.eta_mins) {
          el("etaLine").textContent = "Estimated ready: " + o.eta_mins + " mins";
        } else if (o.status === "ready") {
          el("etaLine").textContent = "Your order is ready.";
        } else if (o.status === "despatched") {
          el("etaLine").textContent = "Order despatched.";
        } else if (o.status === "collected") {
          el("etaLine").textContent = "Order collected.";
        } else {
          el("etaLine").textContent = "";
        }
      },

      startPoll() {
        this.stopPoll();
        state.orderPoll = setInterval(()=>this.pollOnce(), 4000); // 4s poll
        this.pollOnce();
      },

      stopPoll() {
        if (state.orderPoll) clearInterval(state.orderPoll);
        state.orderPoll = null;
      }
    };

    // --- Events ---
    el("cartBar").addEventListener("click", ()=>ui.openCart());
    el("search").addEventListener("input", (e)=>{ state.q = e.target.value.trim(); renderMenu(); });

    el("btnDelivery").onclick = () => {
      state.deliveryType = "delivery";
      el("btnDelivery").classList.add("active");
      el("btnCollection").classList.remove("active");
      updateCartBar();
    };
    el("btnCollection").onclick = () => {
      state.deliveryType = "collection";
      el("btnCollection").classList.add("active");
      el("btnDelivery").classList.remove("active");
      updateCartBar();
    };

    // --- Boot ---
    loadVenueStatus();
    setInterval(loadVenueStatus, 30000);

    loadMenu().catch(()=> {
      el("restName").textContent = "MenuLinx";
      toast("Menu failed to load (KV not set yet)");
    });
  </script>
</body>
</html>
