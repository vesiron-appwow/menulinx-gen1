---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Menu">

<div id="menu"></div>

<div class="card">
  <input id="customerName" placeholder="Your name" />
  <input id="customerContact" placeholder="Telephone number" style="margin-top:8px;" />
</div>

<div class="basket-bar">
  <div>Total: £<span id="total">0.00</span></div>
  <button id="checkout">Place Order</button>
</div>

<script>
let menu = null;
let basket = [];

function formatPrice(pence) {
  return (pence / 100).toFixed(2);
}

function calculateTotal() {
  let total = 0;
  basket.forEach(item => {
    total += item.pricePence * item.qty;
  });
  document.getElementById("total").innerText = formatPrice(total);
}

function renderMenu() {
  const container = document.getElementById("menu");
  container.innerHTML = "";

  menu.items.forEach(item => {
    const pricePence = Math.round(item.price * 100);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <strong>${item.name}</strong><br/>
      <small>${item.description}</small><br/>
      £${item.price.toFixed(2)}<br/><br/>
      <button>Add</button>
    `;

    card.querySelector("button").onclick = () => {
      const existing = basket.find(b => b.itemId === item.id);
      if (existing) {
        existing.qty += 1;
      } else {
        basket.push({
          itemId: item.id,
          name: item.name,
          qty: 1,
          pricePence
        });
      }
      calculateTotal();
    };

    container.appendChild(card);
  });
}

async function loadMenu() {
  const res = await fetch("/api/menu?venueId=default");
  const data = await res.json();
  menu = data.menu;
  renderMenu();
}

document.getElementById("checkout").onclick = async () => {
  if (!basket.length) {
    alert("Basket empty");
    return;
  }

  const customerName = document.getElementById("customerName").value;
  const customerContact = document.getElementById("customerContact").value;

  if (!customerName || !customerContact) {
    alert("Name and telephone required");
    return;
  }

  const payload = {
    venueId: "default",
    customerName,
    customerContact,
    items: basket.map(b => ({
      itemId: b.itemId,
      qty: b.qty
    }))
  };

  const res = await fetch("/api/orders", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  if (data.ok) {
    alert("Order placed successfully");
    basket = [];
    calculateTotal();
    document.getElementById("customerName").value = "";
    document.getElementById("customerContact").value = "";
  } else {
    alert("Order failed");
  }
};

loadMenu();
</script>
