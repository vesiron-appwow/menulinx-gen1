---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Menu">
  <div id="menu"></div>

  <div class="card">
    <h3>Your Details</h3>
    <input id="custName" placeholder="Customer Name" />
    <br /><br />
    <input id="custContact" placeholder="Phone / Email" />
  </div>

  <div id="basketContainer"></div>

  <div class="basket-bar">
    <div>Total: £<span id="total">0.00</span></div>
    <button id="checkoutBtn">Place Order</button>
  </div>

<script type="module">
let basket = [];
let menuData = null;

const menuEl = document.getElementById("menu");
const basketEl = document.getElementById("basketContainer");
const totalEl = document.getElementById("total");
const checkoutBtn = document.getElementById("checkoutBtn");

async function loadMenu() {
  const res = await fetch("/api/menu?venueId=default", {
    cache: "no-store"
  });
  const data = await res.json();
  menuData = data.menu;
  renderMenu();
}

function renderMenu() {
  menuEl.innerHTML = "";

  menuData.items.forEach(item => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <strong>${item.name}</strong><br/>
      <small>${item.description}</small><br/><br/>
      £${item.price.toFixed(2)}<br/><br/>
      <button>Add</button>
    `;

    div.querySelector("button").onclick = () => {
      basket.push({
        itemId: item.id,
        name: item.name,
        qty: 1
      });
      renderBasket();
    };

    menuEl.appendChild(div);
  });
}

function renderBasket() {
  basketEl.innerHTML = "";
  let total = 0;

  basket.forEach((item, index) => {
    const price = menuData.items.find(i => i.id === item.itemId).price;
    total += price * item.qty;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      ${item.name} x ${item.qty}
      <button class="secondary" style="float:right;">Remove</button>
    `;

    div.querySelector("button").onclick = () => {
      basket.splice(index, 1);
      renderBasket();
    };

    basketEl.appendChild(div);
  });

  totalEl.textContent = total.toFixed(2);
}

checkoutBtn.onclick = async () => {
  if (basket.length === 0) {
    alert("Basket empty");
    return;
  }

  const name = document.getElementById("custName").value.trim();
  const contact = document.getElementById("custContact").value.trim();

  if (!name || !contact) {
    alert("Enter name and contact");
    return;
  }

  checkoutBtn.disabled = true;
  checkoutBtn.textContent = "Sending...";

  const res = await fetch("/api/orders", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    cache: "no-store",
    body: JSON.stringify({
      venueId: "default",
      customerName: name,
      customerContact: contact,
      items: basket
    })
  });

  const result = await res.json();

  if (result.ok) {
    alert("Order placed successfully");
    basket = [];
    document.getElementById("custName").value = "";
    document.getElementById("custContact").value = "";
    renderBasket();
  } else {
    alert("Order failed");
  }

  checkoutBtn.disabled = false;
  checkoutBtn.textContent = "Place Order";
};

loadMenu();
</script>
</BaseLayout>
