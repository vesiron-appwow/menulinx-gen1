---
import Layout from "../layouts/BaseLayout.astro";
---

<Layout title="Menu">

<div id="menu"></div>

<div class="basket-bar">
  <div>
    <div><strong>Basket</strong></div>
    <div>Total: £<span id="total">0.00</span></div>
  </div>
  <button onclick="checkout()">Checkout</button>
</div>

<script>
let basket = [];

function renderBasket() {
  const total = basket.reduce((sum, i) => sum + (i.price * i.qty), 0);
  document.getElementById("total").textContent = total.toFixed(2);
}

function addItem(item) {
  const existing = basket.find(i => i.id === item.id);
  if (existing) existing.qty++;
  else basket.push({ ...item, qty: 1 });
  renderBasket();
}

async function loadMenu() {
  const r = await fetch("/api/menu?venueId=default");
  const data = await r.json();
  const menu = data.menu;

  const container = document.getElementById("menu");
  container.innerHTML = "";

  menu.items.forEach(item => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div style="font-weight:600">${item.name}</div>
      <div style="color:#6b7280; font-size:14px">${item.description}</div>
      <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center">
        <div>£${item.price.toFixed(2)}</div>
        <button>Add</button>
      </div>
    `;
    div.querySelector("button").onclick = () => addItem(item);
    container.appendChild(div);
  });
}

async function checkout() {
  if (!basket.length) return alert("Basket empty");

  const name = prompt("Customer name");
  if (!name) return;

  const contact = prompt("Contact number");
  if (!contact) return;

  const payload = {
    venueId: "default",
    customerName: name,
    customerContact: contact,
    items: basket.map(i => ({
      itemId: i.id,
      name: i.name,
      qty: i.qty,
      unitPrice: i.price
    }))
  };

  const r = await fetch("/api/orders", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await r.json();

  if (!r.ok) {
    alert(data.error || "Order failed");
    return;
  }

  alert("Order placed ✓");
  basket = [];
  renderBasket();
}

loadMenu();
</script>

</Layout>
